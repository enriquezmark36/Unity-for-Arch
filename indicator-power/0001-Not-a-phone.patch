From 08d077e51cecda056692c0ff78c20d01546f09b4 Mon Sep 17 00:00:00 2001
From: Xiao-Long Chen <chenxiaolong@cxl.epac.to>
Contributor: Michael Healy <horsemanoffaith@gmail.com>
Date: Sat, 9 Aug 2014 14:56:18 -0400
Subject: [PATCH] Not a phone

---
 CMakeLists.txt | 3 +--
 src/notifier.c | 2 --
 src/service.c  | 4 ----
 3 files changed, 1 insertion(+), 8 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 569100d..30be771 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -37,8 +37,7 @@ pkg_check_modules(SERVICE_DEPS REQUIRED
                   gio-2.0>=2.36
                   gio-unix-2.0>=2.36
                   gudev-1.0>=204
-                  libnotify>=0.7.6
-                  gstreamer-1.0>=1.2
-                  url-dispatcher-1>=1)
+                  libnotify>=0.7.6
+                  gstreamer-1.0>=1.2)
 
 include_directories (SYSTEM ${SERVICE_DEPS_INCLUDE_DIRS})
 
--- a/src/notifier.c	2016-01-20 20:00:39.361004030 -0800
+++ a/src/notifier.c	2016-01-20 20:16:18.397711317 -0800
@@ -18,13 +18,11 @@
  */
 
 #include "datafiles.h"
-#include "dbus-accounts-sound.h"
 #include "dbus-battery.h"
 #include "dbus-shared.h"
 #include "notifier.h"
 #include "sound-player.h"
 
-#include <url-dispatcher.h>
 
 #include <libnotify/notify.h>
 
@@ -86,8 +84,7 @@
   IndicatorPowerSoundPlayer * sound_player;
 
   GCancellable * cancellable;
-  DbusAccountsServiceSound * accounts_service_sound_proxy;
-  gboolean accounts_service_sound_proxy_pending;
+
 }
 IndicatorPowerNotifierPrivate;
 
@@ -142,82 +139,6 @@
 }
 
 /***
-****  Sounds
-***/
-
-static void
-on_sound_proxy_ready (GObject      * source_object G_GNUC_UNUSED,
-                      GAsyncResult * res,
-                      gpointer       gself)
-{
-  GError * error;
-  DbusAccountsServiceSound * proxy;
-
-  error = NULL;
-  proxy = dbus_accounts_service_sound_proxy_new_for_bus_finish (res, &error);
-  if (error != NULL)
-    {
-      if (!g_error_matches(error, G_IO_ERROR, G_IO_ERROR_CANCELLED))
-        {
-          get_priv(gself)->accounts_service_sound_proxy_pending = FALSE;
-          g_debug("%s Couldn't find accounts service sound proxy: %s", G_STRLOC, error->message);
-        }
-
-      g_clear_error(&error);
-    }
-  else
-    {
-      IndicatorPowerNotifier * const self = INDICATOR_POWER_NOTIFIER(gself);
-      priv_t * const p = get_priv (self);
-      g_clear_object (&p->accounts_service_sound_proxy);
-      p->accounts_service_sound_proxy = proxy;
-      p->accounts_service_sound_proxy_pending = FALSE;
-    }
-}
-
-static gboolean
-silent_mode (IndicatorPowerNotifier * self)
-{
-  priv_t * const p = get_priv (self);
-
-  /* if we don't have a proxy yet, assume we're in silent mode
-     as a "do no harm" level of response */
-  if (p->accounts_service_sound_proxy_pending)
-    return TRUE;
-
-  return (p->accounts_service_sound_proxy != NULL)
-      && dbus_accounts_service_sound_get_silent_mode(p->accounts_service_sound_proxy);
-}
-
-static void
-play_low_battery_sound (IndicatorPowerNotifier * self)
-{
-  const gchar * const key = LOW_BATTERY_SOUND;
-  gchar * filename;
-  priv_t * const p = get_priv(self);
-
-  /* can't play? */
-  g_return_if_fail (p->sound_player != NULL);
-
-  /* won't play? */
-  if (silent_mode(self))
-    return;
-
-  filename = datafile_find(DATAFILE_TYPE_SOUND, key);
-  if (filename != NULL)
-    {
-      gchar * uri = g_filename_to_uri(filename, NULL, NULL);
-      indicator_power_sound_player_play_uri (p->sound_player, uri);
-      g_free(uri);
-      g_free(filename);
-    }
-  else
-    {
-      g_warning("Unable to find '%s' in XDG data dirs", key);
-    }
-}
-
-/***
 ****  Notifications
 ***/
 
@@ -259,7 +180,6 @@
                             char               * action    G_GNUC_UNUSED,
                             gpointer             user_data G_GNUC_UNUSED)
 {
-  url_dispatch_send("settings:///system/battery", NULL, NULL);
 }
 
 static void
@@ -387,7 +307,6 @@
       ((new_power_level != POWER_LEVEL_OK) && new_discharging && !old_discharging))
     {
       notification_show (self);
-      play_low_battery_sound (self);
     }
   else if (!new_discharging || (new_power_level == POWER_LEVEL_OK))
     {
@@ -467,7 +387,6 @@
   notification_clear (self);
   indicator_power_notifier_set_battery (self, NULL);
   g_clear_object (&p->dbus_battery);
-  g_clear_object (&p->accounts_service_sound_proxy);
 
   G_OBJECT_CLASS (indicator_power_notifier_parent_class)->dispose (o);
 }
@@ -502,17 +422,6 @@
   if (!instance_count++ && !notify_init("indicator-power-service"))
     g_critical("Unable to initialize libnotify! Notifications might not be shown.");
 
-  p->accounts_service_sound_proxy_pending = TRUE;
-  gchar* object_path = g_strdup_printf("/org/freedesktop/Accounts/User%lu", (gulong)getuid());
-  dbus_accounts_service_sound_proxy_new_for_bus(
-    G_BUS_TYPE_SYSTEM,
-    G_DBUS_PROXY_FLAGS_GET_INVALIDATED_PROPERTIES,
-    "org.freedesktop.Accounts",
-    object_path,
-    p->cancellable,
-    on_sound_proxy_ready,
-    self);
-  g_clear_pointer(&object_path, g_free);
 }
 
 static void

diff --git a/src/service.c b/src/service.c
index 665151c..bc82a41 100644
--- a/src/service.c
+++ b/src/service.c
@@ -20,7 +20,6 @@
 
 #include <glib/gi18n.h>
 #include <gio/gio.h>
-#include <url-dispatcher.h>
 
 #include "brightness.h"
 #include "dbus-shared.h"
@@ -785,7 +784,5 @@ on_settings_activated (GSimpleAction * a      G_GNUC_UNUSED,
     {
       if (g_getenv ("MIR_SOCKET") != NULL)
         {
-          url_dispatch_send("settings:///system/battery", NULL, NULL);
-          return;
         }
       else if (!g_strcmp0 (g_getenv ("DESKTOP_SESSION"), "xubuntu"))
@@ -833,7 +831,6 @@ on_phone_settings_activated (GSimpleAction * a      G_GNUC_UNUSED,
                              GVariant      * param  G_GNUC_UNUSED,
                              gpointer        gself  G_GNUC_UNUSED)
 {
-  url_dispatch_send("settings:///system/battery", NULL, NULL);
 }
 
 /***
-- 
2.1.1
